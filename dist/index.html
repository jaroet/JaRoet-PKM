<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JaRoet PKM</title>
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              background: 'var(--background)',
              foreground: 'var(--foreground)',
              card: 'var(--card)',
              'card-foreground': 'var(--card-foreground)',
              primary: 'var(--primary)',
              'primary-foreground': 'var(--primary-foreground)',
            }
          }
        }
      }
    </script>
    
    <!-- App Styles -->
    <style>
      :root {
        --background: #f8fafc;
        --foreground: #0f172a;
        --card: #ffffff;
        --card-foreground: #0f172a;
        --primary: #3b82f6;
        --primary-foreground: #ffffff;
        --scrollbar-thumb: #94a3b8;
      }
      .dark {
        --background: #0f172a;
        --foreground: #f8fafc;
        --card: #1e293b;
        --card-foreground: #f8fafc;
        --primary: #60a5fa;
        --primary-foreground: #0f172a;
        --scrollbar-thumb: #475569;
      }
      body {
        background-color: var(--background);
        color: var(--foreground);
        transition: background-color 0.3s, color 0.3s;
      }
      
      /* Custom Scrollbar Styles */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb) transparent;
      }
      
      .custom-scrollbar::-webkit-scrollbar {
        width: 12px;
        height: 12px;
        display: block;
      }
      
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb);
        border-radius: 6px;
        border: 3px solid transparent;
        background-clip: content-box;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: var(--primary);
      }
      
      .custom-scrollbar::-webkit-scrollbar-corner {
        background: transparent;
      }
    </style>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://unpkg.com/marked@9.1.2/marked.min.js"></script>
    <!-- Babel for on-the-fly compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        // --- React Hooks & Global Shims ---
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- Configure Marked for External Links ---
        const renderer = new marked.Renderer();
        const originalLink = renderer.link;
        renderer.link = function(href, title, text) {
            const isExternal = href && (href.startsWith('http') || href.startsWith('//'));
            const target = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
            const titleAttr = title ? ` title="${title}"` : '';
            
            let output = `<a href="${href}"${titleAttr}${target}>${text}`;
            
            if (isExternal) {
                 output += '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-0.5 opacity-70 mb-0.5 align-baseline"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';
            }
            output += '</a>';
            return output;
        };
        marked.use({ renderer });

        // --- 1. Types ---
        
        interface Note {
          id: string;
          title: string;
          content: string;
          linksTo: string[];   // Downers (Children)
          relatedTo: string[]; // Lefters (Lateral)
          isFavorite: boolean;
          createdAt: number;
          modifiedAt: number;
        }

        type Section = 'center' | 'up' | 'down' | 'left' | 'right' | 'favs' | 'content';

        interface Topology {
          center: Note | null;
          uppers: Note[];
          downers: Note[];
          lefters: Note[];
          righters: Note[];
        }

        interface SearchResult {
          id: string;
          title: string;
        }

        type Theme = 'light' | 'dark';

        interface Point {
          x: number;
          y: number;
        }

        interface Connection {
          from: Point;
          to: Point;
          type: 'hierarchical' | 'lateral';
        }

        // --- 2. Database Services ---
        
        // Dexie is available globally as 'Dexie'

        // --- Vault Management ---

        const VAULT_LIST_KEY = 'nexusnode_vaults';
        const CURRENT_VAULT_KEY = 'nexusnode_current_vault';
        const DEFAULT_VAULT = 'JaRoet-PKM';

        if (!localStorage.getItem(VAULT_LIST_KEY)) {
            localStorage.setItem(VAULT_LIST_KEY, JSON.stringify([DEFAULT_VAULT]));
        }
        if (!localStorage.getItem(CURRENT_VAULT_KEY)) {
            localStorage.setItem(CURRENT_VAULT_KEY, DEFAULT_VAULT);
        }

        const getVaultList = () => {
            try {
                return JSON.parse(localStorage.getItem(VAULT_LIST_KEY) || '[]');
            } catch {
                return [DEFAULT_VAULT];
            }
        };

        const getCurrentVaultName = () => {
            return localStorage.getItem(CURRENT_VAULT_KEY) || DEFAULT_VAULT;
        };

        // --- Database Class ---

        class PKMDatabase extends Dexie {
          // Type shim for TS in Babel
          notes;
          meta;

          constructor() {
            super(getCurrentVaultName());
            this.version(1).stores({
              notes: 'id, title, *linksTo, *relatedTo', 
              meta: 'key',
            });
          }
        }

        const db = new PKMDatabase();

        // --- Vault Operations ---

        const switchVault = (name) => {
            if (getVaultList().includes(name)) {
                localStorage.setItem(CURRENT_VAULT_KEY, name);
                window.location.reload();
            }
        };

        const createVault = (name) => {
            const list = getVaultList();
            const sanitizedName = name.trim();
            if (sanitizedName && !list.includes(sanitizedName)) {
                list.push(sanitizedName);
                localStorage.setItem(VAULT_LIST_KEY, JSON.stringify(list));
                localStorage.setItem(CURRENT_VAULT_KEY, sanitizedName); 
                window.location.reload();
            }
        };

        const deleteCurrentVault = async () => {
            const current = getCurrentVaultName();
            db.close();
            await Dexie.delete(current);
            let list = getVaultList();
            list = list.filter(v => v !== current);
            if (list.length === 0) list.push(DEFAULT_VAULT);
            localStorage.setItem(VAULT_LIST_KEY, JSON.stringify(list));
            localStorage.setItem(CURRENT_VAULT_KEY, list[0]); 
            window.location.reload();
        };

        const resetCurrentVault = async () => {
            await db.transaction('rw', db.notes, db.meta, async () => {
                await db.notes.clear();
                await db.meta.clear();
            });
            window.location.reload();
        };

        // --- Seed Data ---
        const seedDatabase = async () => {
          const count = await db.notes.count();
          if (count === 0) {
            const now = Date.now();
            const n1 = {
              id: crypto.randomUUID(),
              title: 'Welcome to JaRoet PKM',
              content: '# Welcome\n\nThis is your Central Note. Use arrow keys to navigate.',
              linksTo: [],
              relatedTo: [],
              isFavorite: false,
              createdAt: now,
              modifiedAt: now,
            };
            
            await db.notes.bulkAdd([n1]);
            await db.meta.put({ key: 'currentCentralNoteId', value: n1.id });
            await db.meta.put({ key: 'favoritesList', value: [] });
            await db.meta.put({ key: 'homeNoteId', value: n1.id });
            return n1.id;
          }
          return null;
        };

        // --- Core Operations ---

        const getNote = async (id) => {
          return await db.notes.get(id);
        };

        const createNote = async (title) => {
          const now = Date.now();
          const note = {
            id: crypto.randomUUID(),
            title,
            content: '',
            linksTo: [],
            relatedTo: [],
            isFavorite: false,
            createdAt: now,
            modifiedAt: now,
          };
          await db.notes.add(note);
          return note;
        };

        const updateNote = async (id, updates) => {
          await db.notes.update(id, { ...updates, modifiedAt: Date.now() });
        };

        const deleteNote = async (id) => {
            await db.transaction('rw', db.notes, db.meta, async () => {
                await db.notes.delete(id);
                await db.notes.where('linksTo').equals(id).modify((note) => {
                    note.linksTo = note.linksTo.filter(linkId => linkId !== id);
                    note.modifiedAt = Date.now();
                });
                await db.notes.where('relatedTo').equals(id).modify((note) => {
                    note.relatedTo = note.relatedTo.filter(linkId => linkId !== id);
                    note.modifiedAt = Date.now();
                });
                const favsMeta = await db.meta.get('favoritesList');
                if (favsMeta && favsMeta.value.includes(id)) {
                    const newFavs = favsMeta.value.filter((favId) => favId !== id);
                    await db.meta.put({ key: 'favoritesList', value: newFavs });
                }
            });
        };

        const getNoteCount = async () => {
            return await db.notes.count();
        };

        // --- Topology ---

        const getTopology = async (centerId) => {
          const center = await db.notes.get(centerId);
          if (!center) {
            return { center: null, uppers: [], downers: [], lefters: [], righters: [] };
          }
          const uppers = await db.notes.where('linksTo').equals(centerId).toArray();
          const downers = await db.notes.bulkGet(center.linksTo);
          const lefters = await db.notes.bulkGet(center.relatedTo);
          const rightersMap = new Map();
          for (const upper of uppers) {
            const siblings = await db.notes.bulkGet(upper.linksTo);
            siblings.forEach(sib => {
              if (sib && sib.id !== centerId) {
                rightersMap.set(sib.id, sib);
              }
            });
          }
          const righters = Array.from(rightersMap.values());
          return {
            center,
            uppers: uppers.filter(Boolean),
            downers: downers.filter(Boolean),
            lefters: lefters.filter(Boolean),
            righters,
          };
        };

        // --- Favorites ---

        const getFavorites = async () => {
          const meta = await db.meta.get('favoritesList');
          const ids = meta ? meta.value : [];
          const notes = await db.notes.bulkGet(ids);
          return notes.filter(Boolean);
        };

        const toggleFavorite = async (noteId) => {
          await db.transaction('rw', db.notes, db.meta, async () => {
            const note = await db.notes.get(noteId);
            if (!note) return;
            const newStatus = !note.isFavorite;
            await db.notes.update(noteId, { isFavorite: newStatus, modifiedAt: Date.now() });
            const meta = await db.meta.get('favoritesList');
            let ids = meta ? meta.value : [];
            if (newStatus) {
              if (!ids.includes(noteId)) ids.push(noteId);
            } else {
              ids = ids.filter(id => id !== noteId);
            }
            await db.meta.put({ key: 'favoritesList', value: ids });
          });
        };

        // --- Home Note ---

        const getHomeNoteId = async () => {
            const meta = await db.meta.get('homeNoteId');
            return meta ? meta.value : null;
        };

        const setHomeNoteId = async (id) => {
            await db.meta.put({ key: 'homeNoteId', value: id });
        };

        // --- Settings ---

        const getFontSize = async () => {
            const meta = await db.meta.get('fontSize');
            return meta ? meta.value : 16;
        };

        const setFontSize = async (size) => {
            await db.meta.put({ key: 'fontSize', value: size });
        };

        interface ThemeConfig {
            background: string;
            section: string;
            accent: string;
            bars: string;
        }

        interface AppTheme {
            light: ThemeConfig;
            dark: ThemeConfig;
        }

        const DEFAULT_THEME = {
            light: {
                background: '#f1f5f9',
                section: '#ffffff',
                accent: '#3b82f6',
                bars: '#e2e8f0'
            },
            dark: {
                background: '#1e293b',
                section: '#0f172a',
                accent: '#60a5fa',
                bars: '#0f172a'
            }
        };

        const getAppTheme = async () => {
            const meta = await db.meta.get('appTheme');
            if (meta && meta.value) {
                return meta.value;
            }
            return DEFAULT_THEME;
        };

        const setAppTheme = async (theme) => {
            await db.meta.put({ key: 'appTheme', value: theme });
        };

        // --- Search ---

        const searchNotes = async (query) => {
          if (!query) return [];
          const q = query.toLowerCase();
          return await db.notes
            .filter(n => n.title.toLowerCase().includes(q))
            .toArray()
            .then(notes => notes.map(n => ({ id: n.id, title: n.title })));
        };

        const getAllNotes = async () => {
          return await db.notes.toArray();
        };

        const importNotes = async (notes) => {
          await db.notes.clear();
          const CHUNK_SIZE = 50; 
          for (let i = 0; i < notes.length; i += CHUNK_SIZE) {
            const chunk = notes.slice(i, i + CHUNK_SIZE);
            await db.notes.bulkAdd(chunk);
            await new Promise(resolve => setTimeout(resolve, 10));
          }
          const favorites = notes.filter(n => n.isFavorite).map(n => n.id);
          await db.meta.put({ key: 'favoritesList', value: favorites });
          if (notes.length > 0) {
              await db.meta.put({ key: 'currentCentralNoteId', value: notes[0].id });
              await db.meta.put({ key: 'homeNoteId', value: notes[0].id });
          }
        };

        // --- 3. Components ---

        // -- NoteCard --
        const NoteCard = ({ note, isFocused, isSelected, isCenter, fontSize, onClick, className, id }) => {
            if (isCenter) {
              return (
                <div
                  id={id}
                  onClick={onClick}
                  className={`
                    relative flex flex-col items-center justify-center transition-all duration-200 cursor-pointer z-20
                    p-6 max-w-3xl text-center
                    ${className || ''}
                  `}
                >
                  <div 
                    style={{ 
                        fontSize: `${fontSize * 1.5}px`,
                        backgroundColor: isFocused ? 'color-mix(in srgb, var(--theme-accent) 20%, transparent)' : undefined,
                        boxShadow: isFocused ? '0 0 0 2px color-mix(in srgb, var(--theme-accent) 50%, transparent)' : undefined
                    }}
                    className={`
                      font-bold leading-tight select-none px-4 py-2 rounded-lg transition-all
                      ${isFocused ? 'backdrop-blur-sm shadow-sm' : ''}
                      text-foreground
                    `}
                  >
                    {note.title}
                  </div>
                </div>
              );
            }

            return (
              <div
                id={id}
                onClick={onClick}
                title={note.title}
                style={{ 
                    fontSize: `${fontSize}px`,
                    backgroundColor: isFocused 
                        ? 'color-mix(in srgb, var(--theme-accent) 20%, transparent)' 
                        : isSelected 
                            ? 'color-mix(in srgb, var(--theme-accent) 10%, transparent)'
                            : undefined,
                    boxShadow: isFocused 
                        ? 'inset 0 0 0 2px color-mix(in srgb, var(--theme-accent) 50%, transparent)' 
                        : isSelected
                            ? 'inset 0 0 0 2px color-mix(in srgb, var(--theme-accent) 30%, transparent)'
                            : undefined
                }}
                className={`
                  relative group flex items-center
                  px-3 py-1.5 rounded-md cursor-pointer select-none transition-all duration-150
                  truncate flex-shrink-0 text-foreground
                  ${
                    isFocused
                      ? 'z-10 shadow-sm font-medium'
                      : 'hover:bg-foreground/5 opacity-90 hover:opacity-100'
                  }
                  ${className || ''}
                `}
              >
                <span className="truncate flex-1">{note.title}</span>
                {isSelected && (
                    <span className="absolute right-2 w-2 h-2 rounded-full bg-[var(--theme-accent)]"></span>
                )}
              </div>
            );
        };

        // -- LinkerModal --
        const LinkerModal = ({ isOpen, type, onClose, onSelect }) => {
          const [query, setQuery] = useState('');
          const [results, setResults] = useState([]);
          const [selectedIndex, setSelectedIndex] = useState(0);
          const inputRef = useRef(null);

          const isBulk = query.includes(';');

          useEffect(() => {
            if (isOpen) {
              setQuery('');
              setResults([]);
              setSelectedIndex(0);
              setTimeout(() => inputRef.current?.focus(), 50);
            }
          }, [isOpen]);

          useEffect(() => {
            const fetch = async () => {
              if (query.trim() && !isBulk) {
                const res = await searchNotes(query);
                setResults(res);
              } else {
                setResults([]);
              }
            };
            const debounce = setTimeout(fetch, 200);
            return () => clearTimeout(debounce);
          }, [query, isBulk]);

          const handleKeyDown = (e) => {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              if (!isBulk) {
                setSelectedIndex(prev => (prev + 1) % (results.length + 1));
              }
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              if (!isBulk) {
                setSelectedIndex(prev => (prev - 1 + (results.length + 1)) % (results.length + 1));
              }
            } else if (e.key === 'Enter') {
              e.preventDefault();
              if (isBulk) {
                if (query.trim()) {
                    onSelect(null, query);
                }
              } else {
                if (selectedIndex < results.length) {
                    onSelect(results[selectedIndex].id);
                } else {
                    if (query.trim()) {
                    onSelect(null, query);
                    }
                }
              }
              onClose();
            } else if (e.key === 'Escape') {
              onClose();
            }
          };

          if (!isOpen) return null;

          const titles = {
            up: 'Link Parent',
            down: 'Link Child',
            left: 'Link Related',
          };

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
              <div className="w-full max-w-md bg-background rounded-xl shadow-2xl border border-gray-200 dark:border-gray-800 p-4">
                <h3 className="text-lg font-semibold mb-2">{titles[type]}</h3>
                <p className="text-xs text-gray-500 mb-3">
                    Use <b>;</b> to separate multiple items (e.g. "Apple; Banana; Orange") for bulk creation.
                </p>
                <input
                  ref={inputRef}
                  type="text"
                  className="w-full p-2 rounded border border-gray-300 dark:border-gray-700 bg-background text-foreground focus:ring-2 focus:ring-primary outline-none"
                  placeholder="Search or type to create..."
                  value={query}
                  onChange={e => setQuery(e.target.value)}
                  onKeyDown={handleKeyDown}
                />
                <div className="mt-2 max-h-60 overflow-y-auto border-t border-gray-100 dark:border-gray-800 pt-2">
                  {isBulk ? (
                     <div
                        className="p-2 rounded cursor-pointer flex items-center gap-2 bg-primary text-primary-foreground"
                        onClick={() => {
                            onSelect(null, query);
                            onClose();
                        }}
                    >
                        <span className="font-bold">+</span> Bulk Create {query.split(';').filter(s => s.trim()).length} Notes
                    </div>
                  ) : (
                    <>
                        {results.map((res, idx) => (
                            <div
                            key={res.id}
                            className={`p-2 rounded cursor-pointer ${
                                idx === selectedIndex ? 'bg-primary text-primary-foreground' : 'hover:bg-gray-100 dark:hover:bg-gray-800'
                            }`}
                            onClick={() => {
                                onSelect(res.id);
                                onClose();
                            }}
                            >
                            {res.title}
                            </div>
                        ))}
                        {query.trim() && (
                            <div
                            className={`p-2 rounded cursor-pointer flex items-center gap-2 ${
                                selectedIndex === results.length ? 'bg-primary text-primary-foreground' : 'hover:bg-gray-100 dark:hover:bg-gray-800'
                            }`}
                            onClick={() => {
                                onSelect(null, query);
                                onClose();
                            }}
                            >
                            <span className="font-bold">+</span> Create "{query}"
                            </div>
                        )}
                    </>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // -- MarkdownEditor --
        const MarkdownEditor = ({ note, isOpen, onClose, onSave }) => {
          const [content, setContent] = useState('');
          const [parsedHtml, setParsedHtml] = useState('');
          const [isPreview, setIsPreview] = useState(true);
          const textareaRef = useRef(null);
          const containerRef = useRef(null);
          const previewRef = useRef(null);

          useEffect(() => {
            if (note && isOpen) {
              const hasContent = note.content && note.content.trim().length > 0;
              setContent(note.content || '');
              setIsPreview(hasContent);
              setTimeout(() => {
                  if (hasContent) {
                      previewRef.current?.focus();
                  } else {
                      textareaRef.current?.focus();
                  }
              }, 100);
            }
          }, [note, isOpen]);

          useEffect(() => {
            const parse = async () => {
                try {
                    const html = await marked.parse(content || '', { breaks: true, gfm: true });
                    setParsedHtml(html);
                } catch (e) {
                    console.error('Markdown parse error:', e);
                    setParsedHtml('<p>Error rendering markdown.</p>');
                }
            };
            const timeout = setTimeout(parse, 100);
            return () => clearTimeout(timeout);
          }, [content]);

          const handleToggleMode = () => {
              if (isPreview) {
                  setIsPreview(false);
                  setTimeout(() => textareaRef.current?.focus(), 50);
              } else {
                  if (note) onSave(note.id, content);
                  setIsPreview(true);
                  setTimeout(() => previewRef.current?.focus(), 50);
              }
          };

          const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              onClose();
              return;
            }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'e') {
                e.preventDefault();
                handleToggleMode();
                return;
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (note) onSave(note.id, content);
                onClose();
            }
          };

          if (!isOpen || !note) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
              <div 
                ref={containerRef}
                tabIndex={-1} 
                onKeyDown={handleKeyDown}
                className="w-full max-w-[90vw] h-[90vh] bg-[var(--theme-bg)] rounded-lg shadow-2xl flex flex-col border border-gray-200 dark:border-gray-800 outline-none"
              >
                <div className="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-background/50 rounded-t-lg">
                  <h2 className="text-xl font-bold truncate pr-4">{note.title}</h2>
                  <div className="flex gap-2 flex-shrink-0">
                    <button
                      onClick={handleToggleMode}
                      title="Ctrl+E"
                      className="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:opacity-80 text-sm min-w-[80px]"
                    >
                      {isPreview ? 'Edit' : 'Preview'}
                    </button>
                    <button
                      onClick={() => {
                        onSave(note.id, content);
                        onClose();
                      }}
                      title="Ctrl+Enter"
                      className="px-3 py-1 rounded bg-primary text-white hover:opacity-80 text-sm"
                    >
                      Save & Close
                    </button>
                     <button
                      onClick={onClose}
                      title="Esc"
                      className="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:opacity-80 text-sm"
                    >
                      Close
                    </button>
                  </div>
                </div>
                
                <div className="flex-1 overflow-hidden relative bg-background/50">
                    {isPreview ? (
                        <div 
                            ref={previewRef}
                            tabIndex={0}
                            className="w-full h-full p-6 overflow-auto prose dark:prose-invert max-w-none custom-scrollbar select-text outline-none"
                            dangerouslySetInnerHTML={{ __html: parsedHtml }}
                        />
                    ) : (
                        <textarea
                            ref={textareaRef}
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            className="w-full h-full p-6 bg-transparent resize-none outline-none font-mono text-base custom-scrollbar"
                            placeholder="Type markdown here..."
                        />
                    )}
                </div>
                <div className="p-2 text-xs text-gray-500 border-t dark:border-gray-700 text-center bg-background/50 rounded-b-lg">
                    {isPreview 
                        ? 'View Mode • Ctrl+E to Edit • Esc to Close' 
                        : 'Edit Mode • Ctrl+E to Save & Preview • Ctrl+Enter to Save & Close • Esc to Cancel'
                    }
                </div>
              </div>
            </div>
          );
        };

        // -- RenameModal --
        const RenameModal = ({ isOpen, currentTitle, onClose, onRename }) => {
          const [title, setTitle] = useState(currentTitle);
          const inputRef = useRef(null);

          useEffect(() => {
            if (isOpen) {
              setTitle(currentTitle);
              setTimeout(() => inputRef.current?.focus(), 50);
            }
          }, [isOpen, currentTitle]);

          const handleSubmit = (e) => {
            e?.preventDefault();
            if (title.trim()) {
              onRename(title.trim());
              onClose();
            }
          };

          const handleKeyDown = (e) => {
              if (e.key === 'Escape') onClose();
          };

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
              <div className="bg-background p-6 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-800 w-full max-w-md">
                <h3 className="text-lg font-bold mb-4">Rename Note</h3>
                <form onSubmit={handleSubmit}>
                  <input
                    ref={inputRef}
                    type="text"
                    value={title}
                    onChange={e => setTitle(e.target.value)}
                    onKeyDown={handleKeyDown}
                    className="w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-transparent focus:ring-2 focus:ring-primary outline-none mb-4 text-foreground"
                    placeholder="Note title..."
                  />
                  <div className="flex justify-end gap-2">
                    <button 
                        type="button" 
                        onClick={onClose} 
                        className="px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        className="px-4 py-2 rounded bg-primary text-primary-foreground hover:opacity-90 transition-opacity"
                    >
                        Rename
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        // -- SettingsModal --
        const SettingsModal = ({ isOpen, onClose, currentCentralNoteId, fontSize, onFontSizeChange, onThemeChange }) => {
          const [activeTab, setActiveTab] = useState('general');
          const [themeMode, setThemeMode] = useState('dark');
          const [homeNoteTitle, setHomeNoteTitle] = useState('Loading...');
          const [searchQuery, setSearchQuery] = useState('');
          const [searchResults, setSearchResults] = useState([]);
          const [localFontSize, setLocalFontSize] = useState(fontSize);
          
          const [appTheme, setLocalAppTheme] = useState(null);
          
          const [newVaultName, setNewVaultName] = useState('');
          const [confirmDelete, setConfirmDelete] = useState(false);
          const [confirmReset, setConfirmReset] = useState(false);
          const [currentVault, setCurrentVault] = useState('');

          useEffect(() => {
            if (isOpen) {
              loadHomeNote();
              loadTheme();
              setSearchQuery('');
              setSearchResults([]);
              setLocalFontSize(fontSize);
              setCurrentVault(getCurrentVaultName());
              setConfirmDelete(false);
              setConfirmReset(false);
              setNewVaultName('');
              setActiveTab('general');
            }
          }, [isOpen, fontSize]);

          const loadTheme = async () => {
              const t = await getAppTheme();
              setLocalAppTheme(t);
          };

          const loadHomeNote = async () => {
            const id = await getHomeNoteId();
            if (id) {
              const note = await getNote(id);
              setHomeNoteTitle(note ? note.title : 'Unknown Note');
            } else {
              setHomeNoteTitle('Not Set');
            }
          };

          const handleSearch = async (val) => {
            setSearchQuery(val);
            if (val.trim()) {
              const res = await searchNotes(val);
              setSearchResults(res);
            } else {
              setSearchResults([]);
            }
          };

          const setHome = async (id, title) => {
            await setHomeNoteId(id);
            setHomeNoteTitle(title);
            setSearchQuery('');
            setSearchResults([]);
          };

          const setCenterAsHome = async () => {
            if (currentCentralNoteId) {
                const note = await getNote(currentCentralNoteId);
                if (note) {
                    await setHome(note.id, note.title);
                }
            }
          };

          const handleFontSizeChange = async (e) => {
              const size = parseInt(e.target.value);
              setLocalFontSize(size);
              onFontSizeChange(size);
              await setFontSize(size);
          };
          
          const handleThemeUpdate = async (key, value) => {
              if (!appTheme) return;
              const newTheme = {
                  ...appTheme,
                  [themeMode]: {
                      ...appTheme[themeMode],
                      [key]: value
                  }
              };
              setLocalAppTheme(newTheme);
              await setAppTheme(newTheme);
              onThemeChange();
          };

          const handleCreateVault = () => {
              if (newVaultName.trim()) {
                  createVault(newVaultName.trim());
              }
          };
          
          const handleReset = () => {
              if (confirmReset) {
                  resetCurrentVault();
              } else {
                  setConfirmReset(true);
              }
          };

          const handleDelete = () => {
              if (confirmDelete) {
                  deleteCurrentVault();
              } else {
                  setConfirmDelete(true);
              }
          };

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
              <div className="w-full max-w-4xl h-[85vh] bg-background rounded-xl shadow-2xl border border-gray-200 dark:border-gray-800 flex flex-col">
                <div className="flex justify-between items-center p-6 pb-2">
                    <h2 className="text-xl font-bold">Settings</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-foreground">✕</button>
                </div>
                
                <div className="flex border-b border-gray-200 dark:border-gray-800 px-6">
                    <button
                        className={`py-2 px-4 text-sm font-medium border-b-2 transition-colors ${
                            activeTab === 'general' 
                            ? 'border-primary text-primary' 
                            : 'border-transparent text-gray-500 hover:text-foreground'
                        }`}
                        onClick={() => setActiveTab('general')}
                    >
                        General
                    </button>
                    <button
                        className={`py-2 px-4 text-sm font-medium border-b-2 transition-colors ${
                            activeTab === 'theme' 
                            ? 'border-primary text-primary' 
                            : 'border-transparent text-gray-500 hover:text-foreground'
                        }`}
                        onClick={() => setActiveTab('theme')}
                    >
                        Theme
                    </button>
                    <button
                        className={`py-2 px-4 text-sm font-medium border-b-2 transition-colors ${
                            activeTab === 'database' 
                            ? 'border-primary text-primary' 
                            : 'border-transparent text-gray-500 hover:text-foreground'
                        }`}
                        onClick={() => setActiveTab('database')}
                    >
                        Database
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto p-6">
                    
                    {activeTab === 'general' && (
                        <div className="space-y-6">
                            <div className="border-b border-gray-100 dark:border-gray-800 pb-6">
                                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Interface Font Size</h3>
                                <div className="flex items-center gap-4">
                                    <span className="text-sm w-8">{localFontSize}px</span>
                                    <input 
                                        type="range" 
                                        min="12" 
                                        max="32" 
                                        step="1"
                                        value={localFontSize}
                                        onChange={handleFontSizeChange}
                                        className="flex-1 accent-primary"
                                    />
                                </div>
                                <p className="text-xs text-gray-400 mt-2">Affects note lists. Central note is 150% of this size.</p>
                            </div>

                            <div>
                                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Home Note</h3>
                                <div className="flex items-center justify-between bg-card p-3 rounded border border-gray-200 dark:border-gray-700 mb-2">
                                    <span className="font-medium truncate">{homeNoteTitle}</span>
                                </div>
                                
                                <button 
                                    onClick={setCenterAsHome}
                                    className="w-full py-2 px-4 bg-primary/10 text-primary rounded hover:bg-primary/20 text-sm font-medium mb-4"
                                >
                                    Set Current View as Home
                                </button>

                                <div className="relative">
                                    <input
                                        type="text"
                                        placeholder="Search note to set as Home..."
                                        className="w-full p-2 rounded border border-gray-300 dark:border-gray-700 bg-background focus:ring-2 focus:ring-primary outline-none"
                                        value={searchQuery}
                                        onChange={(e) => handleSearch(e.target.value)}
                                    />
                                    {searchResults.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 bg-card border border-gray-200 dark:border-gray-700 shadow-lg rounded-b mt-1 z-50 max-h-48 overflow-y-auto">
                                            {searchResults.map(res => (
                                                <div 
                                                    key={res.id} 
                                                    className="p-2 hover:bg-primary/10 cursor-pointer text-sm"
                                                    onClick={() => setHome(res.id, res.title)}
                                                >
                                                    {res.title}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'theme' && appTheme && (
                        <div className="space-y-6">
                            <div className="flex justify-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg mb-6">
                                <button
                                    className={`flex-1 py-1 text-sm font-medium rounded-md transition-all ${
                                        themeMode === 'light' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900 dark:hover:text-gray-300'
                                    }`}
                                    onClick={() => setThemeMode('light')}
                                >
                                    Light Mode
                                </button>
                                <button
                                    className={`flex-1 py-1 text-sm font-medium rounded-md transition-all ${
                                        themeMode === 'dark' ? 'bg-gray-600 text-white shadow-sm' : 'text-gray-500 hover:text-gray-900 dark:hover:text-gray-300'
                                    }`}
                                    onClick={() => setThemeMode('dark')}
                                >
                                    Dark Mode
                                </button>
                            </div>

                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <span className="font-medium text-sm">Background Color</span>
                                        <span className="text-xs text-gray-500">The gutters/canvas background</span>
                                    </div>
                                    <input 
                                        type="color" 
                                        value={appTheme[themeMode].background}
                                        onChange={e => handleThemeUpdate('background', e.target.value)}
                                        className="h-8 w-14 p-0 border-0 rounded cursor-pointer"
                                    />
                                </div>

                                <div className="flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <span className="font-medium text-sm">Section Color</span>
                                        <span className="text-xs text-gray-500">Background for note containers</span>
                                    </div>
                                    <input 
                                        type="color" 
                                        value={appTheme[themeMode].section}
                                        onChange={e => handleThemeUpdate('section', e.target.value)}
                                        className="h-8 w-14 p-0 border-0 rounded cursor-pointer"
                                    />
                                </div>

                                <div className="flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <span className="font-medium text-sm">Bars Background</span>
                                        <span className="text-xs text-gray-500">Top bar and status bar</span>
                                    </div>
                                    <input 
                                        type="color" 
                                        value={appTheme[themeMode].bars}
                                        onChange={e => handleThemeUpdate('bars', e.target.value)}
                                        className="h-8 w-14 p-0 border-0 rounded cursor-pointer"
                                    />
                                </div>

                                <div className="flex items-center justify-between">
                                    <div className="flex flex-col">
                                        <span className="font-medium text-sm">Accent Color</span>
                                        <span className="text-xs text-gray-500">Icons and active elements</span>
                                    </div>
                                    <input 
                                        type="color" 
                                        value={appTheme[themeMode].accent}
                                        onChange={e => handleThemeUpdate('accent', e.target.value)}
                                        className="h-8 w-14 p-0 border-0 rounded cursor-pointer"
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'database' && (
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Current Database</h3>
                                <div className="bg-gray-100 dark:bg-gray-800 p-3 rounded mb-4 border border-gray-200 dark:border-gray-700">
                                    <div className="text-xs text-gray-500 mb-1">Active Vault</div>
                                    <div className="font-mono font-bold text-lg text-primary truncate">{currentVault}</div>
                                </div>
                            </div>

                            <div>
                                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">New Vault</h3>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="Vault Name..." 
                                        className="flex-1 p-2 rounded border border-gray-300 dark:border-gray-700 bg-background outline-none focus:ring-1 focus:ring-primary"
                                        value={newVaultName}
                                        onChange={e => setNewVaultName(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && handleCreateVault()}
                                    />
                                    <button 
                                        onClick={handleCreateVault}
                                        disabled={!newVaultName.trim()}
                                        className="px-3 py-2 bg-primary text-primary-foreground rounded hover:opacity-90 disabled:opacity-50"
                                    >
                                        Create
                                    </button>
                                </div>
                            </div>

                            <div className="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
                                <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wide">Danger Zone</h3>
                                
                                <div>
                                    <button 
                                        onClick={handleReset}
                                        className={`w-full py-2 px-4 rounded text-sm font-medium transition-all ${
                                            confirmReset 
                                                ? 'bg-red-500 text-white hover:bg-red-600' 
                                                : 'bg-gray-200 dark:bg-gray-700 text-foreground hover:opacity-80'
                                        }`}
                                    >
                                        {confirmReset ? 'Confirm: Reset (Clear Data)' : 'Reset Current Vault'}
                                    </button>
                                    {confirmReset && <p className="text-xs text-red-500 mt-1 text-center">Warning: All notes in this vault will be lost.</p>}
                                </div>

                                <div>
                                    <button 
                                        onClick={handleDelete}
                                        className={`w-full py-2 px-4 rounded text-sm font-medium transition-all ${
                                            confirmDelete 
                                                ? 'bg-red-500 text-white hover:bg-red-600' 
                                                : 'bg-red-500/10 text-red-500 hover:bg-red-500/20'
                                        }`}
                                    >
                                        {confirmDelete ? 'Confirm: DELETE VAULT PERMANENTLY' : 'Delete Current Vault'}
                                    </button>
                                     {confirmDelete && <p className="text-xs text-red-500 mt-1 text-center">Warning: This vault and all its data will be destroyed.</p>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                
                <div className="flex justify-end p-4 border-t border-gray-100 dark:border-gray-800">
                    <button onClick={onClose} className="px-4 py-2 rounded bg-primary text-primary-foreground hover:opacity-90">Done</button>
                </div>
              </div>
            </div>
          );
        }

        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>